name: simulate_dbs_variable

display_name: "Variable Simulate Database workloads"

summary:
  Do Bursty fio min 5s start background first. 500 IOP per guest

description: "Simulate a datacenter virtualization workload with a variety of workload types"

tags:
  - hackathon

estimated_runtime: 300

vars: 
    _vcpu_per_small_vm:
        default: 2
    _mem_per_small_vm:
        default: 4096    
    _vcpu_per_medium_vm:
        default: 4
    _mem_per_medium_vm:
        default: 16384
    _vcpu_per_large_vm:
        default: 16
    _mem_per_large_vm:
        default: 32768
    _vcpu_per_xlarge_vm:
        default: 32
    _mem_per_xlarge_vm:
        default: 65536         
    A_small_target_per_cluster:
        description: |
            How many Small VMs (2vCPU, 4GB) per cluster on average.
        display_name: Small VMs per cluster
        default: 10
        min: 1        
    B_medium_target_per_cluster:
        description: |
            How many Medium VMs (4vCPU, 16GB) per cluster on average.
        display_name: Medium VMs per cluster
        default: 5
        min: 1
    C_large_target_per_cluster:
        description: |
            How many Large VMs (16vCPU, 32GB) per cluster on average.
        display_name: Large VMs per cluster
        default: 2
        min: 1
    D_xlarge_target_per_cluster:
        description: |
            How many Extra Large (32vCPU, 64GB) VMs  per cluster on average.
        display_name: Extra Large VMs per cluster
        default: 1
        min: 1
    E_iterations:
        description: |
            How many cycles to run Each Cycle rougly 1 minute.
        display_name: Total Cycles (minutes) after prefill.
        default: 30
        min: 1
        max: 500        
vms:
  - vmsmall:
      template: ubuntu1604
      vcpus: {{ _vcpu_per_small_vm }}
      ram_mb: {{ _mem_per_small_vm }}
      data_disks:
        count: 3
        size: 1
      count_per_cluster: {{ A_small_target_per_cluster }}

  - vmmedium:
      template: ubuntu1604
      vcpus: {{ _vcpu_per_medium_vm }}
      ram_mb: {{ _mem_per_medium_vm }}
      data_disks:
        count: 3
        size: 1
      count_per_cluster: {{ B_medium_target_per_cluster }}

  - vmlarge:
      template: ubuntu1604
      vcpus: {{ _vcpu_per_large_vm }}
      ram_mb: {{ _mem_per_large_vm}}
      data_disks:
        count: 3
        size: 1
      count_per_cluster: {{ C_large_target_per_cluster }}

  - vmxlarge:
      template: ubuntu1604
      vcpus: {{ _vcpu_per_xlarge_vm }}
      ram_mb: {{ _mem_per_xlarge_vm }}
      data_disks:
        count: 6
        size: 1
      count_per_cluster: {{ D_xlarge_target_per_cluster }}
workloads: []

results: 
  - IOPS Small:
      vm_group: vmsmall
      result_type: iops
      result_hint: "Bursty IO Simulation"
      report_group: performance
      aggregate: sum
      report_metrics:
        - Variability
  - IOPS Medium:
      vm_group: vmmedium
      result_type: iops
      result_hint: "Bursty IO Simulation"
      report_group: performance
      aggregate: sum
      report_metrics:
        - Variability      
  - IOPS Large:
      vm_group: vmlarge
      result_type: iops
      result_hint: "Bursty IO Simulation"
      report_group: performance
      aggregate: sum
      report_metrics:
        - Variability
  - IOPS XLarge:
      vm_group: vmxlarge
      result_type: iops
      result_hint: "Bursty IO Simulation"
      report_group: performance
      aggregate: sum
      report_metrics:
        - Variability      

setup:
  - cluster.CleanUp: {}
  - vm_group.CloneFromTemplate:
      vm_group_name: vmsmall
  - vm_group.CloneFromTemplate:
      vm_group_name: vmmedium
  - vm_group.CloneFromTemplate:
      vm_group_name: vmlarge
  - vm_group.CloneFromTemplate:
      vm_group_name: vmxlarge      
  - vm_group.PowerOn:
      vm_group_name: vmsmall
  - vm_group.PowerOn:
      vm_group_name: vmmedium
  - vm_group.PowerOn:
      vm_group_name: vmlarge
  - vm_group.PowerOn:
      vm_group_name: vmxlarge
run:
  - playbook.Run:
      filename: runfio.yml
      variables:
        vms_per_cluster: {{ A_small_target_per_cluster + B_medium_target_per_cluster + C_large_target_per_cluster + D_xlarge_target_per_cluster }}
        smallcpu:  {{ _vcpu_per_small_vm }}
        mediumcpu: {{ _vcpu_per_medium_vm }}
        largecpu:  {{ _vcpu_per_large_vm}}
        xlargecpu: {{ _vcpu_per_xlarge_vm }}
        iterations: {{ E_iterations }}
      inventory:
        - vmsmall
        - vmmedium
        - vmlarge
        - vmxlarge
      forks: 255
      remote_user: root
      remote_pass: nutanix/4u   
teardown:
  - cluster.CleanUp: {}      


